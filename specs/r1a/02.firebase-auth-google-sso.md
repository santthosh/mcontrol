# Firebase Auth Integration — Google SSO Login Flow

## Context

Mission Control currently has **no authentication**. The API auth middleware (`apps/api/app/middleware/auth.py`) is stubbed — it returns 501 when `AUTH_DISABLED=false`. The desktop app sends no auth headers. This task implements a complete Google SSO login flow using Firebase Auth so users must sign in before accessing the app, and all API calls carry validated Firebase ID tokens.

**After this task, launching the app presents a login screen. Users sign in with Google (or a dev shortcut in emulator mode), and all subsequent API calls are authenticated.**

---

## Architecture: Server-Mediated OAuth with Polling

Tauri v2's webview does not reliably support Firebase JS SDK `signInWithPopup()` (popup windows blocked by default). Instead we use a **server-mediated flow** — the API handles the Google OAuth exchange, the desktop opens the system browser for consent, and polls for the result. This avoids the Firebase JS SDK entirely on the client.

### Production Flow

```
Desktop                     System Browser              API
  │                              │                       │
  ├─ POST /auth/google/start ──────────────────────────► │  (1) get session_id + auth_url
  │◄── { session_id, auth_url } ─────────────────────────┤
  │                              │                       │
  ├─ open(auth_url) ───────────► │                       │  (2) user sees Google consent
  │                              ├─ Google OAuth ───────► │
  │                              │◄── redirect ──────────┤
  │                              │                       │  (3) exchange code → tokens
  │                              │  "Return to app" page │      create/update user
  │                              │                       │
  ├─ GET /auth/google/poll ────────────────────────────► │  (4) poll until complete
  │◄── { id_token, refresh_token, user } ────────────────┤
  │                              │                       │
  ├─ store tokens locally        │                       │  (5) all future API calls
  ├─ Authorization: Bearer <id_token> ──────────────────► │      carry the token
```

### Emulator/Dev Flow

1. Desktop detects `VITE_FIREBASE_AUTH_EMULATOR_HOST` is set
2. Shows a simple email input + "Dev Sign In" button instead of Google button
3. Calls `POST /api/auth/dev/signin` with email → API creates user in emulator, returns tokens

---

## 1. API Changes — `apps/api/`

### 1.1 Configuration — `app/lib/config.py`

Add to `Settings`:
- `google_client_id: str = ""` — Google OAuth 2.0 client ID
- `google_client_secret: str = ""` — Google OAuth 2.0 client secret
- `api_base_url: str = "http://localhost:8000"` — for constructing OAuth redirect URI

### 1.2 Auth Middleware — `app/middleware/auth.py`

Replace the 501 stub with real Firebase token verification:

**Production mode** (no emulator):
```python
from firebase_admin import auth
from app.lib.firebase import _initialize_app
_initialize_app()
decoded = auth.verify_id_token(token)
```

**Emulator mode** (`FIREBASE_AUTH_EMULATOR_HOST` set):
```python
# POST to emulator's accounts:lookup endpoint
url = f"http://{emulator_host}/identitytoolkit.googleapis.com/v1/accounts:lookup"
resp = httpx.post(url, json={"idToken": token}, params={"key": "fake-api-key"})
```

Update `AuthUser` class to carry `display_name` and `avatar_url` from the decoded token.

### 1.3 Auth Routes — `app/routes/auth.py` (new file)

| Method | Path | Auth | Purpose |
|--------|------|------|---------|
| `POST` | `/api/auth/google/start` | No | Generate `session_id` + Google OAuth URL |
| `GET` | `/api/auth/google/callback` | No | Browser redirect target; exchange code → Firebase tokens → create user |
| `GET` | `/api/auth/google/poll` | No | Desktop polls for OAuth result by `session_id` |
| `POST` | `/api/auth/dev/signin` | No | Emulator-only: create user + return tokens with just an email |
| `GET` | `/api/auth/me` | Yes | Return authenticated user's Firestore profile |

**Session storage:** in-memory dict with 5-minute TTL (production can migrate to Redis).

**Callback page:** Returns HTML telling the user to close the tab and return to the desktop app.

### 1.4 Router Registration — `app/main.py`

Add `app.include_router(auth.router, prefix="/api")`.

### 1.5 Environment — `.env.example`

Add:
```
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
API_BASE_URL=http://localhost:8000
```

---

## 2. Desktop Infrastructure — `apps/desktop/`

### 2.1 New Dependencies

**Cargo.toml:**
```toml
tauri-plugin-shell = "2"
```

**package.json:**
```json
"@tauri-apps/plugin-shell": "^2.0.0"
```

### 2.2 Plugin Registration — `src-tauri/src/lib.rs` and `src-tauri/src/main.rs`

Add `.plugin(tauri_plugin_shell::init())` to the Tauri builder.

### 2.3 Tauri Capabilities — `src-tauri/capabilities/default.json`

Add to permissions:
- `"shell:allow-open"` — open system browser for OAuth
- `http:allow-fetch` domains:
  - `http://localhost:9099/**` — auth emulator
  - `https://securetoken.googleapis.com/**` — token refresh

### 2.4 Environment Types — `src/vite-env.d.ts`

Add `VITE_FIREBASE_AUTH_EMULATOR_HOST?: string` to `ImportMetaEnv`.

### 2.5 Auth Module — `src/lib/auth.ts` (new file)

Core functions:
- `signInWithGoogle()` — call API start, open browser via shell plugin, poll for result
- `signInDev(email)` — call API dev/signin (emulator mode)
- `refreshIdToken(refreshToken)` — POST to `securetoken.googleapis.com/v1/token`
- `getStoredAuth()` / `saveAuth()` / `clearAuth()` — localStorage wrappers
- `getValidToken()` — return current ID token, refresh if expired
- `isEmulatorMode()` — check `VITE_FIREBASE_AUTH_EMULATOR_HOST`

### 2.6 API Client — `src/lib/api.ts`

- Add `fetchWithAuth(url, options)` that injects `Authorization: Bearer <token>`
- Add methods: `startGoogleAuth()`, `pollGoogleAuth()`, `devSignIn()`, `getCurrentUser()`
- Keep `checkHealth()` unauthenticated

---

## 3. Desktop UI — `apps/desktop/src/`

### 3.1 Auth Context — `contexts/AuthContext.tsx` (new file)

React context provider:
- On mount: check localStorage for existing tokens, validate/refresh
- Expose: `isLoading`, `isAuthenticated`, `user`, `signIn()`, `signOut()`
- Background token refresh timer (5 min before expiry)

### 3.2 Login Screen — `components/LoginScreen.tsx` (new file)

Full-screen centered layout:
- App logo + "Mission Control" heading
- **Production:** "Sign in with Google" button
- **Emulator:** email input + "Dev Sign In" button
- Loading spinner during OAuth flow
- Error message display
- Tailwind styled (gray-50 bg, primary color accents)

### 3.3 User Menu — `components/UserMenu.tsx` (new file)

Header component:
- User avatar circle (image or initials fallback)
- Dropdown on click: display name, email, "Sign Out" button
- Same dropdown pattern as existing `ConnectionStatus.tsx`

### 3.4 App Shell — `App.tsx`

- Wrap in `<AuthProvider>`
- If loading → loading spinner
- If not authenticated → `<LoginScreen />`
- If authenticated → existing app shell with `<UserMenu />` in header

---

## File Summary

### New Files

| File | Purpose |
|------|---------|
| `apps/api/app/routes/auth.py` | Auth API endpoints |
| `apps/desktop/src/lib/auth.ts` | Auth logic, token management, storage |
| `apps/desktop/src/contexts/AuthContext.tsx` | React auth context provider |
| `apps/desktop/src/components/LoginScreen.tsx` | Login page UI |
| `apps/desktop/src/components/UserMenu.tsx` | User avatar + dropdown |

### Modified Files

| File | Change |
|------|--------|
| `apps/api/app/lib/config.py` | Add Google OAuth + API base URL settings |
| `apps/api/app/middleware/auth.py` | Replace 501 stub with real Firebase verification |
| `apps/api/app/main.py` | Register auth router |
| `apps/api/.env.example` | Add Google OAuth vars |
| `apps/desktop/src-tauri/Cargo.toml` | Add `tauri-plugin-shell` |
| `apps/desktop/package.json` | Add `@tauri-apps/plugin-shell` |
| `apps/desktop/src-tauri/src/lib.rs` | Register shell plugin |
| `apps/desktop/src-tauri/src/main.rs` | Register shell plugin |
| `apps/desktop/src-tauri/capabilities/default.json` | Add shell + Firebase/Google domains |
| `apps/desktop/src/vite-env.d.ts` | Add emulator host env type |
| `apps/desktop/src/lib/api.ts` | Add `fetchWithAuth()` + auth API methods |
| `apps/desktop/src/App.tsx` | Wrap in AuthProvider, gate behind auth |

---

## Definition of Done

1. **Login gate:** Launching the app shows a login screen — no access to main UI without signing in
2. **Dev sign-in works:** With Firebase Emulator running, enter any email and sign in immediately
3. **Tokens persist:** Close and reopen the app — session is restored without re-login
4. **Token refresh:** Expired tokens are automatically refreshed in the background
5. **API auth works:** Protected routes (e.g., `/api/auth/me`) return 401 without a token, 200 with a valid token
6. **Sign out works:** Clicking sign out clears tokens and returns to the login screen
7. **All checks pass:** `make lint`, `make typecheck`, `make test` pass with zero errors

---

## What NOT to build

- Role-based access control or permissions
- Password/email authentication (Google SSO only)
- Account settings or profile editing
- Multi-factor authentication
- Session management UI (active sessions, revoke)
- Rate limiting on auth endpoints
